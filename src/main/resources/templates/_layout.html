<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:fragment="layout(title, content, currentPage)">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title th:text="${title} + ' - QR Patrol'"></title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link th:href="@{/vendor/fontawesome-free/css/all.min.css}" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" th:href="@{/img/icons/icon-192x192.png}">
  <link rel="apple-touch-icon" th:href="@{/img/icons/icon-192x192.png}">
  <link rel="manifest" th:href="@{/manifest.json}">
  <meta name="theme-color" content="#4F46E5">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'inter': ['Inter', 'sans-serif'], },
          colors: {
            primary: { 50: '#EEF2FF', 100: '#E0E7FF', 200: '#C7D2FE', 500: '#6366F1', 600: '#4F46E5', 700: '#4338CA', 800: '#3730A3', 900: '#312E81', },
            accent: { 100: '#D1FAE5', 600: '#059669', 700: '#047857', 800: '#065F46' }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar-scrollbar::-webkit-scrollbar { width: 4px; }
    .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .sidebar-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
    input:checked ~ .dot { transform: translateX(100%); background-color: #4F46E5; }
  </style>
</head>

<body class="bg-gray-100 text-gray-900 overflow-x-hidden">
<div class="flex h-screen">

  <!-- Desktop Sidebar -->
  <div class="hidden lg:flex lg:flex-shrink-0">
    <div class="flex flex-col w-72">
      <div class="flex flex-col flex-grow bg-gray-900 text-white overflow-y-auto sidebar-scrollbar">
        <div class="flex items-center justify-center px-6 py-6 bg-black/20">
          <a th:href="@{/}" class="flex items-center space-x-3">
            <div class="flex items-center justify-center w-10 h-10 bg-primary-600 rounded-lg backdrop-blur-sm transform -rotate-12">
              <i class="fas fa-qrcode text-white text-lg"></i>
            </div>
            <span class="text-xl font-bold text-white">QR Patrol</span>
          </a>
        </div>
        <nav class="flex-1 px-4 py-4 space-y-1">
          <a th:href="@{/dashboard}" th:classappend="${currentPage == 'dashboard' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-all">
            <i class="fas fa-tachometer-alt mr-3 text-lg w-6 text-center"></i> <span>Tổng quan</span>
          </a>
          <div class="pt-4 pb-2 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Chức năng</div>
          <a sec:authorize="hasAuthority('ROLE_ADMIN')" th:href="@{/admin/users}" th:classappend="${currentPage == 'admin_users' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-all">
            <i class="fas fa-users-cog mr-3 text-lg w-6 text-center"></i> <span>Người dùng</span>
          </a>
          <a sec:authorize="hasAnyAuthority('ROLE_ADMIN','VIEWER')" th:href="@{/admin/qrcodes}" th:classappend="${currentPage == 'admin_qrcodes' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-all">
            <i class="fas fa-qrcode mr-3 text-lg w-6 text-center"></i> <span>Mã QR</span>
          </a>
          <a sec:authorize="hasAnyAuthority('ROLE_ADMIN', 'VIEWER')" th:href="@{/admin/logs}" th:classappend="${currentPage == 'logs' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-all">
            <i class="fas fa-history mr-3 text-lg w-6 text-center"></i> <span>Nhật ký</span>
          </a>
          <a sec:authorize="hasAnyAuthority('ROLE_ADMIN', 'VIEWER')" th:href="@{/admin/violations}" th:classappend="${currentPage == 'admin_violations' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-all">
            <i class="fas fa-car-crash mr-3 text-lg w-6 text-center"></i> <span>Vi phạm</span>
          </a>
          <a sec:authorize="hasAuthority('SCANNER')" th:href="@{/scanner/scan}" th:classappend="${currentPage == 'scanner_scan' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-all">
            <i class="fas fa-camera mr-3 text-lg w-6 text-center"></i> <span>Quét Mã</span>
          </a>
        </nav>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Top Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="flex items-center justify-between px-4 sm:px-6 py-3">
        <button type="button" id="sidebarToggleTop" class="lg:hidden p-2 rounded-lg text-gray-600 hover:bg-gray-100"><i class="fas fa-bars text-lg"></i></button>
        <div class="flex-1"></div>
        <div sec:authorize="isAuthenticated()" class="relative">
          <button id="userDropdown" type="button" class="flex items-center space-x-3 p-1.5 rounded-full hover:bg-gray-100 transition-colors" onclick="toggleDropdown()">
            <img class="w-9 h-9 rounded-full ring-2 ring-primary-200 object-cover" th:src="${#authentication.principal.avatar != null ? '/user-avatars/' + #authentication.principal.avatar : '/img/undraw_profile.svg'}" alt="Avatar">
            <div class="hidden sm:block text-right">
              <p class="text-sm font-medium text-gray-900" th:text="${#authentication.principal.fullName != null ? #authentication.principal.fullName : #authentication.principal.username}"></p>
              <p class="text-xs text-gray-500 capitalize" th:text="${#strings.toLowerCase(#strings.replace(#authentication.principal.authorities[0].authority, 'ROLE_', ''))}"></p>
            </div>
          </button>
          <div id="dropdownMenu" class="absolute right-0 mt-2 w-56 bg-white shadow-lg rounded-lg opacity-0 invisible transform scale-95 transition-all z-50 border border-gray-200">
            <div class="py-1">
              <div class="px-4 py-2 border-b border-gray-100"><p class="text-sm font-semibold text-gray-800" th:text="${#authentication.principal.fullName}"></p><p class="text-xs text-gray-500" th:text="${#authentication.principal.username}"></p></div>
              <a th:href="@{/profile}" class="flex items-center gap-x-3 py-2 px-4 text-sm text-gray-800 hover:bg-gray-100"><i class="fas fa-user-circle w-5 text-gray-400"></i> Hồ sơ cá nhân</a>
              <a th:href="@{/}" class="flex items-center gap-x-3 py-2 px-4 text-sm text-gray-800 hover:bg-gray-100"><i class="fas fa-globe w-5 text-gray-400"></i> Trang chủ</a>
              <div class="border-t border-gray-200 my-1"></div>
              <form th:action="@{/logout}" method="post" class="w-full"><button type="submit" class="w-full flex items-center gap-x-3 py-2 px-4 text-sm text-red-600 hover:bg-red-50"><i class="fas fa-sign-out-alt w-5 text-red-500"></i> Đăng xuất</button></form>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-auto bg-gray-100">
      <div class="p-4 sm:p-6"><div th:replace="${content}"></div></div>
    </main>
  </div>
</div>

<div id="mobile-sidebar" class="fixed inset-0 z-50 flex lg:hidden hidden">
  <div id="mobile-sidebar-backdrop" class="fixed inset-0 bg-black/50" onclick="closeMobileSidebar()"></div>
  <div id="mobile-sidebar-content" class="relative w-72 h-full bg-gray-900 text-white flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out">
    <div class="flex items-center justify-between px-6 py-4 bg-black/20">
      <a th:href="@{/}" class="flex items-center space-x-3"><div class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center transform -rotate-12"><i class="fas fa-qrcode text-white"></i></div><span class="text-lg font-bold text-white">QR Patrol</span></a>
      <button type="button" class="p-2 rounded-lg text-gray-300 hover:text-white hover:bg-gray-700" onclick="closeMobileSidebar()"><i class="fas fa-times"></i></button>
    </div>
    <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto sidebar-scrollbar">
      <a th:href="@{/dashboard}" th:classappend="${currentPage == 'dashboard' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><i class="fas fa-tachometer-alt mr-3 text-lg w-6 text-center"></i> <span>Tổng quan</span></a>
      <div class="pt-4 pb-2 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Chức năng</div>
      <a sec:authorize="hasAuthority('ROLE_ADMIN')" th:href="@{/admin/users}" th:classappend="${currentPage == 'admin_users' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><i class="fas fa-users-cog mr-3 text-lg w-6 text-center"></i> <span>Người dùng</span></a>
      <a sec:authorize="hasAnyAuthority('ROLE_ADMIN','VIEWER')" th:href="@{/admin/qrcodes}" th:classappend="${currentPage == 'admin_qrcodes' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><i class="fas fa-qrcode mr-3 text-lg w-6 text-center"></i> <span>Mã QR</span></a>
      <a sec:authorize="hasAnyAuthority('ROLE_ADMIN', 'VIEWER')" th:href="@{/admin/logs}" th:classappend="${currentPage == 'logs' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><i class="fas fa-history mr-3 text-lg w-6 text-center"></i> <span>Nhật ký</span></a>
      <a sec:authorize="hasAnyAuthority('ROLE_ADMIN', 'VIEWER')" th:href="@{/admin/violations}" th:classappend="${currentPage == 'admin_violations' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><i class="fas fa-car-crash mr-3 text-lg w-6 text-center"></i> <span>Vi phạm</span></a>
      <a sec:authorize="hasAuthority('SCANNER')" th:href="@{/scanner/scan}" th:classappend="${currentPage == 'scanner_scan' ? 'bg-primary-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" class="group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><i class="fas fa-camera mr-3 text-lg w-6 text-center"></i> <span>Quét Mã</span></a>
    </nav>
  </div>
</div>

<button type="button" id="scrollToTop" class="fixed bottom-6 right-6 p-3 bg-primary-600 text-white rounded-full shadow-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-all opacity-0 invisible z-40" onclick="document.querySelector('main').scrollTo({top: 0, behavior: 'smooth'})"><i class="fas fa-arrow-up"></i></button>

<script>
  function toggleDropdown() {
    const dropdown = document.getElementById('dropdownMenu');
    dropdown.classList.toggle('opacity-0');
    dropdown.classList.toggle('invisible');
    dropdown.classList.toggle('scale-95');
  }
  document.addEventListener('click', (event) => {
    const dropdown = document.getElementById('dropdownMenu');
    const button = document.getElementById('userDropdown');
    if (button && !button.contains(event.target) && !dropdown.contains(event.target)) {
      dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
    }
  });

  const mobileSidebar = document.getElementById('mobile-sidebar');
  const mobileSidebarContent = document.getElementById('mobile-sidebar-content');
  const sidebarToggleTop = document.getElementById('sidebarToggleTop');

  function openMobileSidebar() {
    mobileSidebar.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    setTimeout(() => {
      mobileSidebarContent.classList.remove('-translate-x-full');
    }, 10);
  }

  function closeMobileSidebar() {
    document.body.style.overflow = '';
    mobileSidebarContent.classList.add('-translate-x-full');
    // Hide the entire overlay after the transition ends
    setTimeout(() => {
      mobileSidebar.classList.add('hidden');
    }, 300);
  }

  if (sidebarToggleTop) {
    sidebarToggleTop.addEventListener('click', openMobileSidebar);
  }

  const mainContent = document.querySelector('main');
  if (mainContent) {
    mainContent.addEventListener('scroll', () => {
      const scrollToTop = document.getElementById('scrollToTop');
      if (mainContent.scrollTop > 100) {
        scrollToTop.classList.remove('opacity-0', 'invisible');
      } else {
        scrollToTop.classList.add('opacity-0', 'invisible');
      }
    });
  }
</script>

</body>
</html>