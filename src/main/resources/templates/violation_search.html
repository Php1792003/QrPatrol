<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: 'Tra cứu vi phạm đỗ xe - QR Patrol System'"></title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <link rel="icon" type="image/png" th:href="@{/img/icons/icon-192x192.png}">
    <link rel="apple-touch-icon" th:href="@{/img/icons/icon-192x192.png}">

    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Gradient animation */
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .gradient-text {
            background: linear-gradient(-45deg, #6366F1, #818CF8, #60A5FA, #6366F1);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 5s ease infinite;
        }

        /* Pattern background */
        .pattern-bg {
            background-color: #f9fafb;
            background-image:
                    radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(129, 140, 248, 0.05) 0%, transparent 50%),
                    radial-gradient(circle at 40% 40%, rgba(96, 165, 250, 0.05) 0%, transparent 50%);
        }

        /* Status colors for violations */
        .border-nhac-nho { border-left-color: #fbbf24; } /* Yellow */
        .bg-nhac-nho { background-color: #fef3c7; border-color: #fbbf24; }

        .border-canh-cao { border-left-color: #f97316; } /* Orange */
        .bg-canh-cao { background-color: #fed7aa; border-color: #f97316; }

        .border-che-tai { border-left-color: #ef4444; } /* Red */
        .bg-che-tai { background-color: #fecaca; border-color: #ef4444; }

        /* Search animation */
        .search-animation {
            animation: searchPulse 2s infinite;
        }

        @keyframes searchPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Loading spinner */
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- Navigation -->
<nav class="fixed top-0 w-full bg-white/90 backdrop-blur-lg shadow-sm z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
            <div class="flex items-center space-x-3">
                <a th:href="@{/}" class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-qrcode text-white text-xl"></i>
                    </div>
                    <span class="text-xl font-bold text-gray-900">QR Patrol</span>
                </a>
            </div>

            <div class="hidden md:flex items-center space-x-8">
                <a th:href="@{/}" class="text-gray-600 hover:text-indigo-600 transition-colors">Trang chủ</a>
                <a th:href="@{/about}" class="text-gray-600 hover:text-indigo-600 transition-colors">Giới thiệu</a>
                <a th:href="@{/violation_search}" class="text-indigo-600 font-medium">Tra cứu</a>
                <a th:href="@{/pricing}" class="text-gray-600 hover:text-indigo-600 transition-colors">Bảng giá</a>
                <a th:href="@{/contact}" class="text-gray-600 hover:text-indigo-600 transition-colors">Liên hệ</a>
            </div>

            <div class="hidden md:flex items-center space-x-4">
                <a th:href="@{/login}" class="text-indigo-600 font-medium hover:text-indigo-700">Đăng nhập</a>
                <a th:href="@{/register}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    Dùng thử
                </a>
            </div>

            <div class="md:hidden flex items-center">
                <button id="mobile-menu-button" class="p-2">
                    <i id="mobile-menu-icon" class="fas fa-bars text-gray-600 text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
        <div class="px-4 pt-2 pb-4 space-y-2">
            <a th:href="@{/}" class="block py-2 px-2 text-gray-600 hover:bg-gray-100 rounded">Trang chủ</a>
            <a th:href="@{/about}" class="block py-2 px-2 text-gray-600 hover:bg-gray-100 rounded">Giới thiệu</a>
            <a th:href="@{/violation_search}" class="block py-2 px-2 text-indigo-600 bg-indigo-50 rounded">Tra cứu</a>
            <a th:href="@{/pricing}" class="block py-2 px-2 text-gray-600 hover:bg-gray-100 rounded">Bảng giá</a>
            <a th:href="@{/contact}" class="block py-2 px-2 text-gray-600 hover:bg-gray-100 rounded">Liên hệ</a>
            <div class="pt-4 mt-4 border-t space-y-3">
                <a th:href="@{/login}" class="block w-full text-center py-2 px-4 border border-indigo-600 text-indigo-600 font-semibold rounded-lg hover:bg-indigo-50">Đăng nhập</a>
                <a th:href="@{/register}" class="block w-full text-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Dùng thử miễn phí</a>
            </div>
        </div>
    </div>
</nav>

<div class="pt-24 pb-12 pattern-bg min-h-screen">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

        <div class="text-center mb-8" data-aos="fade-down">
            <div class="w-20 h-20 bg-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-search text-indigo-600 text-3xl"></i>
            </div>
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                Tra cứu <span class="gradient-text">vi phạm đỗ xe</span>
            </h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                Vui lòng nhập thông tin để xem chi tiết vi phạm gần nhất của phương tiện
            </p>
        </div>

        <div class="max-w-2xl mx-auto" data-aos="zoom-in">
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                <form th:action="@{/violation-search}" method="post" id="searchForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <div class="space-y-6">
                        <div>
                            <label for="licensePlate" class="block text-sm font-semibold text-gray-900 mb-2">
                                <i class="fas fa-car text-indigo-600 mr-2"></i>
                                Biển số xe <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg font-mono uppercase"
                                   id="licensePlate"
                                   name="licensePlate"
                                   th:value="${searchedLicensePlate}"
                                   placeholder="Ví dụ: 51G12345"
                                   required
                                   pattern="[0-9A-Za-z]{6,10}"
                                   title="Biển số xe từ 6-10 ký tự, bao gồm số và chữ">
                            <p class="mt-1 text-sm text-gray-500">Nhập biển số xe viết liền, không có dấu cách</p>
                        </div>

                        <div>
                            <label for="apartmentCode" class="block text-sm font-semibold text-gray-900 mb-2">
                                <i class="fas fa-building text-indigo-600 mr-2"></i>
                                Mã căn hộ <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                                   id="apartmentCode"
                                   name="apartmentCode"
                                   th:value="${searchedApartmentCode}"
                                   placeholder="Ví dụ: A1-101"
                                   required>
                            <p class="mt-1 text-sm text-gray-500">Nhập mã căn hộ theo định dạng: Tòa-Tầng-Số</p>
                        </div>

                        <button type="submit"
                                class="w-full py-4 px-6 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed"
                                id="submitBtn">
                            <span class="submit-text">
                                <i class="fas fa-search mr-2"></i>
                                Tìm kiếm vi phạm
                            </span>
                            <span class="loading-text hidden">
                                <div class="loading-spinner inline-block mr-2"></div>
                                Đang tìm kiếm...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div th:if="${violations}" class="max-w-4xl mx-auto" data-aos="fade-up" data-aos-delay="200">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-history text-indigo-600 mr-2"></i>
                        Lịch sử vi phạm
                    </h2>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-600">Biển số:</span>
                        <span class="px-3 py-1 bg-indigo-100 text-indigo-800 font-mono font-bold rounded-lg" th:text="${searchedLicensePlate}"></span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div th:each="violation, iterStat : ${violations}"
                         class="border-l-4 bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow"
                         th:classappend="${'border-' + #strings.toLowerCase(violation.status.name().replace('_', '-'))}">

                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center font-bold text-gray-700"
                                     th:text="${iterStat.count}"></div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Vi phạm lần thứ <span th:text="${iterStat.count}"></span></h3>
                                    <p class="text-sm text-gray-500" th:text="${#temporals.format(violation.violationDate, &quot;EEEE, dd/MM/yyyy 'lúc' HH:mm&quot;)}"></p>
                                </div>
                            </div>

                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                  th:classappend="${violation.status.name() == 'NHAC_NHO' ? 'bg-yellow-100 text-yellow-800' :
                                                 (violation.status.name() == 'CANH_CAO' ? 'bg-orange-100 text-orange-800' :
                                                 'bg-red-100 text-red-800')}"
                                  th:text="${violation.status.displayName}">
                            </span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-2">Thông tin vi phạm</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar-alt text-gray-400 w-5"></i>
                                        <span class="text-gray-600 ml-2">Ngày vi phạm:</span>
                                        <span class="ml-2 font-medium" th:text="${#temporals.format(violation.violationDate, 'dd/MM/yyyy HH:mm')}"></span>
                                    </div>

                                    <div th:if="${violation.status.name() == 'CHE_TAI'}" class="flex items-start">
                                        <i class="fas fa-exclamation-triangle text-red-500 w-5 mt-0.5"></i>
                                        <div class="ml-2">
                                            <span class="text-gray-600">Chi tiết chế tài:</span>
                                            <p class="text-red-600 font-semibold mt-1" th:text="${violation.sanctionDetails}"></p>
                                        </div>
                                    </div>

                                    <div class="flex items-start">
                                        <i class="fas fa-sticky-note text-gray-400 w-5 mt-0.5"></i>
                                        <div class="ml-2">
                                            <span class="text-gray-600">Ghi chú:</span>
                                            <p class="mt-1" th:text="${violation.notes ?: 'Không có ghi chú'}"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div th:if="${violation.evidenceImage != null and not #strings.isEmpty(violation.evidenceImage)}">
                                <h4 class="font-semibold text-gray-900 mb-2">Bằng chứng</h4>
                                <div class="relative group">
                                    <img th:src="@{'/violation-images/' + ${violation.evidenceImage}}"
                                         alt="Ảnh vi phạm"
                                         class="w-full h-48 object-cover rounded-lg border border-gray-200 cursor-pointer group-hover:opacity-75 transition-opacity"
                                         onclick="openImageModal(this.src)">
                                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        <div class="bg-black bg-opacity-50 text-white px-3 py-1 rounded-lg text-sm">
                                            <i class="fas fa-expand mr-1"></i>
                                            Xem phóng to
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-800" th:text="${#lists.size(violations.?[status.name() == 'NHAC_NHO'])}"></div>
                            <div class="text-sm text-yellow-600">Lần nhắc nhở</div>
                        </div>
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <div class="text-2xl font-bold text-orange-800" th:text="${#lists.size(violations.?[status.name() == 'CANH_CAO'])}"></div>
                            <div class="text-sm text-orange-600">Lần cảnh cáo</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl font-bold text-red-800" th:text="${#lists.size(violations.?[status.name() == 'CHE_TAI'])}"></div>
                            <div class="text-sm text-red-600">Lần chế tài</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${notFound}" class="max-w-2xl mx-auto" data-aos="fade-up" data-aos-delay="200">
            <div class="bg-blue-50 border border-blue-200 rounded-2xl p-8 text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-info-circle text-blue-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-blue-900 mb-2">Không tìm thấy vi phạm</h3>
                <p class="text-blue-700 mb-4">
                    Không tìm thấy thông tin vi phạm nào khớp với biển số <strong th:text="${searchedLicensePlate}"></strong>
                    và mã căn hộ <strong th:text="${searchedApartmentCode}"></strong>.
                </p>
                <div class="text-sm text-blue-600">
                    <p>Vui lòng kiểm tra lại thông tin hoặc liên hệ ban quản lý nếu có thắc mắc.</p>
                </div>
            </div>
        </div>

        <div class="max-w-4xl mx-auto mt-12" data-aos="fade-up" data-aos-delay="400">
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl p-8">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Cần hỗ trợ?</h3>
                    <p class="text-gray-600">Chúng tôi luôn sẵn sàng giúp đỡ bạn</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-phone text-indigo-600"></i>
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-1">Hotline hỗ trợ</h4>
                        <p class="text-gray-600 text-sm">0905 441 263</p>
                    </div>
                    <div class="text-center">
                        <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-envelope text-indigo-600"></i>
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-1">Email hỗ trợ</h4>
                        <p class="text-gray-600 text-sm">support@qrpatrol.vn</p>
                    </div>
                    <div class="text-center">
                        <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-clock text-indigo-600"></i>
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-1">Giờ làm việc</h4>
                        <p class="text-gray-600 text-sm">T2 - T6: 8:00 - 18:00</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="relative max-w-4xl max-h-full p-4">
        <img id="modalImage" src="" alt="Enlarged image" class="max-w-full max-h-full rounded-lg">
        <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 text-2xl">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<script>
    AOS.init({
        duration: 1000,
        once: true
    });

    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuIcon = document.getElementById('mobile-menu-icon');

        function toggleMobileMenu() {
            const isMenuOpen = !mobileMenu.classList.contains('hidden');
            mobileMenu.classList.toggle('hidden');

            if (isMenuOpen) {
                mobileMenuIcon.classList.replace('fa-times', 'fa-bars');
            } else {
                mobileMenuIcon.classList.replace('fa-bars', 'fa-times');
            }
        }

        if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', toggleMobileMenu);
        }

        // Form submission loading state
        const form = document.getElementById('searchForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = submitBtn.querySelector('.submit-text');
        const loadingText = submitBtn.querySelector('.loading-text');

        form.addEventListener('submit', function() {
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            loadingText.classList.remove('hidden');
        });

        // Auto-format license plate input
        const licensePlateInput = document.getElementById('licensePlate');
        licensePlateInput.addEventListener('input', function(e) {
            // Remove spaces and convert to uppercase
            this.value = this.value.replace(/\s/g, '').toUpperCase();
        });
    });

    // Image modal functions
    function openImageModal(src) {
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        modalImage.src = src;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeImageModal();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeImageModal();
        }
    });
</script>
</body>
</html>